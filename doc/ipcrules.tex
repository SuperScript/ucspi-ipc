\documentclass{book}
\usepackage{sstdef}
\title{ucspi-ipc}

\begin{document}

\section{The \cmd{ipcrules} program}

\subsection{Interface}
\begin{code}%
  ipcrules \var{cdb} \var{tmp}
\end{code}
where \cvar{cdb} is the name of the cdb-format output file, and
\cvar{tmp} is the name of a temporary file.
\cmd{ipcserver} optionally follows rules to decide whether a
local-domain connection is acceptable.  For example, the rule
\begin{code}%
  1001.1010:deny
\end{code}
prohibits connections from a process with effective user ID 1001 and
effective group ID 1010.

\cmd{ipcrules} reads rules from its standard input and writes them
into \cvar{cdb} in a binary format suited for quick access by
\cmd{ipcserver}.

\cmd{ipcrules} can be used while \cmd{ipcserver} is running.  It
ensures that \cvar{cdb} is updated atomically.  It does this by first
writing the rules to \cvar{tmp} and then moving \cvar{tmp} on top of
\cvar{cdb}.  If \cvar{tmp} already exists, it is destroyed.  The
directories containing \cvar{cdb} and \cvar{tmp} must be writable to
\cmd{ipcrules}, and must also be on the same filesystem.

If there is a problem with the input or with \cvar{tmp}, \cmd{ipcrules}
complains and leaves \cvar{cdb} alone.

\subsection{Rule format}
A rule occupies one line.  A file containing rules may also contain
comments: lines beginning with \# are ignored.

Each rule contains an \textbf{effective ID}, a colon, and a list of
\textbf{instructions}, with no extra spaces.  When \cmd{ipcserver}
receives a connection from that userid, it follows the instructions.

\subsection{Effective IDs}
\cmd{ipcserver} looks for rules with various userids:
\begin{enumerate}
\item \cmd{\$IPCREMOTEEUID.\$IPCREMOTEEGID};
\item \cmd{\$IPCREMOTEEUID};
\item \cmd{.\$IPCREMOTEEGID};
\item the empty string.
\end{enumerate}
\cmd{ipcserver} uses the first matching rule it finds.

For example, here are some rules:
\begin{code}%
  1001.1010:first
  1002:second
  :third
  .1010:fourth
\end{code}

If \cmd{\$IPCREMOTEEUID} is 5 and \cmd{\$IPCREMOTEEGID} is 10,
\cmd{ipcserver} will follow the third instruction.

If \cmd{\$IPCREMOTEEUID} is 1002, \cmd{ipcserver} will follow the
second instruction.

If \cmd{\$IPCREMOTEEUID} is 5 and \cmd{\$IPCREMOTEEGID} is 1010,
\cmd{ipcserver} will follow the fourth instruction.

If \cmd{\$IPCREMOTEEUID} is 1001 and \cmd{\$IPCREMOTEEGID} is 1010,
\cmd{ipcserver} will follow the first instruction.

You can use \cmd{ipcrulescheck} to see how \cmd{ipcserver} will
interpret rules in \cvar{cdb}.

\subsection{User ranges}
\cmd{ipcrules} treats
\begin{code}%
  1001-1023:instructions
\end{code}
as an abbreviation for the rules
\begin{code}%
  1001:instructions
  1002:instructions
  ...
  1023:instructions
\end{code}

\subsection{Instructions}
The instructions in a rule must begin with either \cmd{allow} or
\cmd{deny}.  An instruction beginning with \cmd{deny} tells
\cmd{ipcserver} to drop the connection without running any program.
For example, the rule
\begin{code}%
  :deny
\end{code}
tells \cmd{ipcserver} to drop any connection that is not handled by a
more specific rule.

The instruction may continue with some environment variables
assignments, in the form \cmd{var="x"}.  \cmd{ipcserver} adds an
environment variable \cmd{\$var} with value \cmd{x}.  For example,
\begin{code}%
  1001:allow,ACCESS="special"
\end{code}
adds an environment variable \cmd{\$ACCESS} with a value of
\cmd{special}.  Any repeated character may appear in place of the
quote character:
\begin{code}%
  1001:allow,ACCESS=/special/
\end{code}
and any number of variables assignments may appear in a single rule:
\begin{code}%
  1001:allow,ACCESS="special",SECRETWORD=/mudshark/
\end{code}
\end{document}
