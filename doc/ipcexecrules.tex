\documentclass{book}
\usepackage{sstdef}
\title{ucspi-ipc}

\begin{document}

\section{The \cmd{ipcexecrules} program}

\subsection{Interface}
\begin{code}%
  ipcexecrules \var{cdb} \var{tmp}
\end{code}
where \cvar{cdb} is the name of the cdb-format output file, and
\cvar{tmp} is the name of a temporary file.
\cmd{ipcexec} follows rules in \cvar{cdb} to decide whether to
execute a program.

\cmd{ipcexecrules} reads rules from its standard input and writes them
into \cvar{cdb} in a binary format suited for quick access by
\cmd{ipcexec}.

\cmd{ipcexecrules} can be used while \cmd{ipcexec} is running.  It
ensures that \cvar{cdb} is updated atomically.  It does this by first
writing the rules to \cvar{tmp} and then moving \cvar{tmp} on top of
\cvar{cdb}.  If \cvar{tmp} already exists, it is destroyed.  The
directories containing \cvar{cdb} and \cvar{tmp} must be writable to
\cmd{ipcexecrules}, and must also be on the same filesystem.

If there is a problem with the input or with \cvar{tmp}, \cmd{ipcexecrules}
complains and leaves \cvar{cdb} alone.

\subsection{Rule format}
A rule occupies one line.  A file containing rules may also contain
comments: lines beginning with \# are ignored.

Each rule contains a \bf{pattern}, a colon, and a list of
\bf{instructions}, with no extra spaces.  When \cmd{ipcexec} receives a
request, it follows the instructions of the first matching pattern in
\cvar{cdb}.

\subsection{Patterns}
\cmd{ipcexec} looks for rules with various patterns:
\begin{enumerate}
\item \cmd{\$IPCREMOTEEUID.\$IPCREMOTEEGID,\var{USERID}.\var{cmd}};
\item \cmd{\$IPCREMOTEEUID,\var{USERID}.\var{cmd}};
\item \cmd{.\$IPCREMOTEEGID,\var{USERID}.\var{cmd}};
\item \cmd{,\var{USERID}.\var{cmd}};
\item the empty string.
\end{enumerate}
\cmd{ipcexec} uses the first matching rule it finds.

For example, here are some rules:
\begin{code}%
  1001.1010,0.echo:allow,first
  1002,0.echo:allow,second
  :deny,third
  .1010,echo:allow,fourth
\end{code}

If \cvar{USERID} is 0 and \cvar{cmd} is \cmd{echo}:
\begin{itemize}
\item
If \cmd{\$IPCREMOTEEUID} is 5 and \cmd{\$IPCREMOTEEGID} is 10,
\cmd{ipcexec} will follow the third instruction.

\item
If \cmd{\$IPCREMOTEEUID} is 1002, \cmd{ipcexec} will follow the
second instruction.

\item
If \cmd{\$IPCREMOTEEUID} is 5 and \cmd{\$IPCREMOTEEGID} is 1010,
\cmd{ipcexec} will follow the fourth instruction.

\item
If \cmd{\$IPCREMOTEEUID} is 1001 and \cmd{\$IPCREMOTEEGID} is 1010,
\cmd{ipcexec} will follow the first instruction.
\end{itemize}

You can use \href{\cmd{ipcexecrulescheck}}{ipcexecrulescheck.html} to see how
\cmd{ipcexec} will interpret rules in \cvar{cdb}.

\subsection{User ranges}
\cmd{ipcexecrules} treats
\begin{code}%
  1001-1023,\var{USERID}.\var{cmd}:instructions
\end{code}
as an abbreviation for the rules
\begin{code}%
  1001,\var{USERID}.\var{cmd}:instructions
  1002,\var{USERID}.\var{cmd}:instructions
  ...
  1023,\var{USERID}.\var{cmd}:instructions
\end{code}

\subsection{Instructions}
The instructions in a rule must begin with either \cmd{allow} or \cmd{deny}.  An
instruction beginning with \cmd{deny} tells \cmd{ipcexec} to exit without
running any program.  For example, the rule
\begin{code}%
  :deny
\end{code}
tells \cmd{ipcexec} to ignore any request that is not handled by a more specific
rule.

An instruction with \cmd{allow} tells \cmd{ipcexec} to execute the request.  It
executes \cvar{cmd} with arguments also read from file descriptor~0.  Arguments
are passed directly to \href{\cmd{pathexec}}{http://cr.yp.to/lib/pathexec.html}
without further interpretation.  If the matching rule instruction begins with
\begin{code}%
  allow="\var{path}"
\end{code}
then \cmd{ipcexec} executes \cvar{path} instead of \cvar{cmd}, with the
arguments specified in the request.  Any repeated character may appear in place
of the quote character.

The instruction may continue with some environment variable assignments, in the
form \cmd{var="x"}.  \cmd{ipcexec} adds an environment variable \cmd{\$var} with
value \cmd{x}.  For example,
\begin{code}%
  1001,0.echo:allow="/bin/echo",ACCESS="special"
\end{code}
adds an environment variable \cmd{\$ACCESS} with a value of
\cmd{special}.  Any repeated character may appear in place of the
quote character:
\begin{code}%
  1001,0.echo:allow="/bin/echo",ACCESS=/special/
\end{code}
and any number of variables assignments may appear in a single rule:
\begin{code}%
  1001,0.echo:allow="/bin/echo",ACCESS="special",SECRETWORD=/mudshark/
\end{code}
\end{document}

